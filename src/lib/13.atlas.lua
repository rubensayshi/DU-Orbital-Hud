-- Planet Info - https://gitlab.com/JayleBreak/dualuniverse/-/tree/master/DUflightfiles/autoconf/custom with minor modifications
function Atlas()
    return {
    [0] = {
        [1]={
                GM=6930729684,
                bodyId=1,
                center={x=17465536.000,y=22665536.000,z=-34464.000},
                name='Madis',
                planetarySystemId=0,
                radius=44300
            },
        [2]={
            GM=157470826617,
            bodyId=2,
            center={x=-8.000,y=-8.000,z=-126303.000},
            name='Alioth',
            planetarySystemId=0,
            radius=126068
            },
        [3]={
            GM=11776905000,
            bodyId=3,
            center={x=29165536.000,y=10865536.000,z=65536.000},
            name='Thades',
            planetarySystemId=0,
            radius=49000
            },
        [4]={
            GM=14893847582,
            bodyId=4,
            center={x=-13234464.000,y=55765536.000,z=465536.000},
            name='Talemai',
            planetarySystemId=0,
            radius=57450
            },
        [5]={
            GM=16951680000,
            bodyId=5,
            center={x=-43534464.000,y=22565536.000,z=-48934464.000},
            name='Feli',
            planetarySystemId=0,
            radius=60000
            },
        [6]={
            GM=10502547741,
            bodyId=6,
            center={x=52765536.000,y=27165538.000,z=52065535.000},
            name='Sicari',
            planetarySystemId=0,
            radius=51100
            },
        [7]={
            GM=13033380591,
            bodyId=7,
            center={x=58665538.000,y=29665535.000,z=58165535.000},
            name='Sinnen',
            planetarySystemId=0,
            radius=54950
            },
        [8]={
            GM=18477723600,
            bodyId=8,
            center={x=80865538.000,y=54665536.000,z=-934463.940},
            name='Teoma',
            planetarySystemId=0,
            radius=62000
            },
        [9]={
            GM=18606274330,
            bodyId=9,
            center={x=-94134462.000,y=12765534.000,z=-3634464.000},
            name='Jago',
            planetarySystemId=0,
            radius=61590
            },
        [10]={
            GM=78480000,
            bodyId=10,
            center={x=17448118.224,y=22966846.286,z=143078.820},
            name='Madis Moon 1',
            planetarySystemId=0,
            radius=10000
            },
        [11]={
            GM=237402000,
            bodyId=11,
            center={x=17194626.000,y=22243633.880,z=-214962.810},
            name='Madis Moon 2',
            planetarySystemId=0,
            radius=11000
            },
        [12]={
            GM=265046609,
            bodyId=12,
            center={x=17520614.000,y=22184730.000,z=-309989.990},
            name='Madis Moon 3',
            planetarySystemId=0,
            radius=15005
            },
        [21]={
            GM=2118960000,
            bodyId=21,
            center={x=457933.000,y=-1509011.000,z=115524.000},
            name='Alioth Moon 1',
            planetarySystemId=0,
            radius=30000
            },
        [22]={
            GM=2165833514,
            bodyId=22,
            center={x=-1692694.000,y=729681.000,z=-411464.000},
            name='Alioth Moon 4',
            planetarySystemId=0,
            radius=30330
            },
        [26]={
            GM=68234043600,
            bodyId=26,
            center={x=-1404835.000,y=562655.000,z=-285074.000},
            name='Sanctuary',
            planetarySystemId=0,
            radius=83400
            },
        [30]={
            GM=211564034,
            bodyId=30,
            center={x=29214402.000,y=10907080.695,z=433858.200},
            name='Thades Moon 1',
            planetarySystemId=0,
            radius=14002
            },
        [31]={
            GM=264870000,
            bodyId=31,
            center={x=29404193.000,y=10432768.000,z=19554.131},
            name='Thades Moon 2',
            planetarySystemId=0,
            radius=15000
            },
        [40]={
            GM=141264000,
            bodyId=40,
            center={x=-13503090.000,y=55594325.000,z=769838.640},
            name='Talemai Moon 2',
            planetarySystemId=0,
            radius=12000
            },
        [41]={
            GM=106830900,
            bodyId=41,
            center={x=-12800515.000,y=55700259.000,z=325207.840},
            name='Talemai Moon 3',
            planetarySystemId=0,
            radius=11000
            },
        [42]={
            GM=264870000,
            bodyId=42,
            center={x=-13058408.000,y=55781856.000,z=740177.760},
            name='Talemai Moon 1',
            planetarySystemId=0,
            radius=15000
            },
        [50]={
            GM=499917600,
            bodyId=50,
            center={x=-43902841.780,y=22261034.700,z=-48862386.000},
            name='Feli Moon 1',
            planetarySystemId=0,
            radius=14000
            },
        [70]={
            GM=396912600,
            bodyId=70,
            center={x=58969616.000,y=29797945.000,z=57969449.000},
            name='Sinnen Moon 1',
            planetarySystemId=0,
            radius=17000
            },
        [100]={
            GM=13975172474,
            bodyId=100,
            center={x=98865536.000,y=-13534464.000,z=-934461.990},
            name='Lacobus',
            planetarySystemId=0,
            radius=55650
            },
        [101]={
            GM=264870000,
            bodyId=101,
            center={x=98905288.170,y=-13950921.100,z=-647589.530},
            name='Lacobus Moon 3',
            planetarySystemId=0,
            radius=15000
            },
        [102]={
            GM=444981600,
            bodyId=102,
            center={x=99180968.000,y=-13783862.000,z=-926156.400},
            name='Lacobus Moon 1',
            planetarySystemId=0,
            radius=18000
            },
        [103]={
            GM=211503600,
            bodyId=103,
            center={x=99250052.000,y=-13629215.000,z=-1059341.400},
            name='Lacobus Moon 2',
            planetarySystemId=0,
            radius=14000
            },
        [110]={
            GM=9204742375,
            bodyId=110,
            center={x=14165536.000,y=-85634465.000,z=-934464.300},
            name='Symeon',
            planetarySystemId=0,
            radius=49050
            },
        [120]={
            GM=7135606629,
            bodyId=120,
            center={x=2865536.700,y=-99034464.000,z=-934462.020},
            name='Ion',
            planetarySystemId=0,
            radius=44950
            },
        [121]={
            GM=106830900,
            bodyId=121,
            center={x=2472916.800,y=-99133747.000,z=-1133582.800},
            name='Ion Moon 1',
            planetarySystemId=0,
            radius=11000
            },
        [122]={
            GM=176580000,
            bodyId=122,
            center={x=2995424.500,y=-99275010.000,z=-1378480.700},
            name='Ion Moon 2',
            planetarySystemId=0,
            radius=15000
            }  
        }
    }
end

for k,v in pairs(Atlas()[0]) do
    if minAtlasX == nil or v.center.x < minAtlasX then
        minAtlasX = v.center.x
    end
    if maxAtlasX == nil or v.center.x > maxAtlasX then
        maxAtlasX = v.center.x
    end
    if minAtlasY == nil or v.center.y < minAtlasY then
        minAtlasY = v.center.y
    end
    if maxAtlasY == nil or v.center.y > maxAtlasY then
        maxAtlasY = v.center.y
    end
end
GalaxyMapHTML = "" -- No starting SVG tag so we can add it where we want it
-- Figure out our scale here... 
local xRatio = 1.1*(maxAtlasX - minAtlasX)/1920 -- Add 10% for padding
local yRatio = 1.4*(maxAtlasY - minAtlasY)/1080 -- Extra so we can get ion back in
for k,v in pairs(Atlas()[0]) do
    -- Draw a circle at the scaled coordinates
    local x = 960 + (v.center.x / xRatio)
    local y = 540 + (v.center.y / yRatio)
    GalaxyMapHTML = GalaxyMapHTML .. '<circle cx="' .. x .. '" cy="' .. y .. '" r="' .. (v.radius/xRatio)*30 .. '" stroke="white" stroke-width="3" fill="blue" />'
    if not string.match(v.name, "Moon") and not string.match(v.name, "Sanctuary") then
        GalaxyMapHTML = GalaxyMapHTML .. "<text x='" .. x .. "' y='" .. y + (v.radius/xRatio)*30 + 20 .. "' font-size='28' fill=" .. rgb .. " text-anchor='middle' font-family='Montserrat'>" .. v.name .. "</text>"
    end
end
-- Draw a 'You Are Here' - face edition
local pos = vec3(core.getConstructWorldPos())
local x = 960 + pos.x/xRatio
local y = 540 + pos.y/yRatio
GalaxyMapHTML = GalaxyMapHTML .. '<circle cx="' .. x .. '" cy="' .. y .. '" r="5" stroke="white" stroke-width="3" fill="red"/>'
GalaxyMapHTML = GalaxyMapHTML .. "<text x='" .. x .. "' y='" .. y - 50 .. "' font-size='36' fill='darkred' text-anchor='middle' font-family='Bank' font-weight='bold'>You Are Here</text>"
GalaxyMapHTML = GalaxyMapHTML .. [[</svg>]]
MapXRatio = xRatio
MapYRatio = yRatio
if screen_2 then
        screen_2.setHTML('<svg width="100vw" height="100vh" viewBox="0 0 1920 1080">' .. GalaxyMapHTML) -- This is permanent and doesn't change
        -- Draw a 'You Are Here' - screen edition
        local pos = vec3(core.getConstructWorldPos())
        local x = 960 + pos.x/xRatio
        local y = 540 + pos.y/yRatio
        GalaxyMapHTML = '<svg><circle cx="80" cy="80" r="5" stroke="white" stroke-width="3" fill="red"/>'
        GalaxyMapHTML = GalaxyMapHTML .. "<text x='80' y='105' font-size='18' fill=" .. rgb .. " text-anchor='middle' font-family='Montserrat''>You Are Here</text></svg>"
        YouAreHere = screen_2.addContent((x-80)/19.20, (y-80)/10.80, GalaxyMapHTML)
end

function PlanetRef() 
    --[[                    START OF LOCAL IMPLEMENTATION DETAILS             ]]--
    -- Type checks
    local function isNumber(n)  return type(n)           == 'number' end
    local function isSNumber(n) return type(tonumber(n)) == 'number' end
    local function isTable(t)   return type(t)           == 'table'  end
    local function isString(s)  return type(s)           == 'string' end
    local function isVector(v)  return isTable(v)
                                        and isNumber(v.x and v.y and v.z) end
    local function isMapPosition(m) return isTable(m) and isNumber(m.latitude  and
                                                                   m.longitude and
                                                                   m.altitude  and
                                                                   m.bodyId    and
                                                                   m.systemId) end
    -- Constants
    local deg2rad    = math.pi/180
    local rad2deg    = 180/math.pi
    local epsilon    = 1e-10
    local num        = ' *([+-]?%d+%.?%d*e?[+-]?%d*)'
    local posPattern = '::pos{' .. num .. ',' .. num .. ',' ..  num .. ',' ..
                       num ..  ',' .. num .. '}'
    -- Utilities
    local utils  = require('cpml.utils')
    local vec3   = require('cpml.vec3')
    local clamp  = utils.clamp
    local function float_eq(a,b)
        if a == 0 then return math.abs(b) < 1e-09 end
        if b == 0 then return math.abs(a) < 1e-09 end
        return math.abs(a - b) < math.max(math.abs(a),math.abs(b))*epsilon
    end
    local function formatNumber(n)
        local result = string.gsub(
                        string.reverse(stringf('%.4f',n)),
                        '^0*%.?','')
        return result == '' and '0' or string.reverse(result)
    end
    local function formatValue(obj)
        if isVector(obj) then
            return stringf('{x=%.3f,y=%.3f,z=%.3f}', obj.x, obj.y, obj.z)
        end
        if isTable(obj) and not getmetatable(obj) then
            local list = {}
            local nxt  = next(obj)
            if type(nxt) == 'nil' or nxt == 1 then -- assume this is an array
                list = obj
            else
                for k,v in pairs(obj) do
                    local value = formatValue(v)
                    if type(k) == 'number' then
                        table.insert(list, stringf('[%s]=%s', k, value))
                    else
                        table.insert(list, stringf('%s=%s',   k, value))
                    end
                end
            end
            return stringf('{%s}', table.concat(list, ','))
        end
        if isString(obj) then
            return stringf("'%s'", obj:gsub("'",[[\']]))
        end
        return tostring(obj)
    end
    -- CLASSES
    -- BodyParameters: Attributes of planetary bodies (planets and moons)
    local BodyParameters = {}
    BodyParameters.__index = BodyParameters
    BodyParameters.__tostring =
        function(obj, indent)
            local sep = indent or ''
            local keys = {}
            for k in pairs(obj) do table.insert(keys, k) end
            table.sort(keys)
            local list = {}
            for _, k in ipairs(keys) do
                local value = formatValue(obj[k])
                if type(k) == 'number' then
                    table.insert(list, stringf('[%s]=%s', k, value))
                else
                    table.insert(list, stringf('%s=%s', k, value))
                end
            end
            if indent then
                return stringf('%s%s',
                                     indent,
                                     table.concat(list, ',\n' .. indent))
            end
            return stringf('{%s}', table.concat(list, ','))
        end
    BodyParameters.__eq = function(lhs, rhs)
            return lhs.planetarySystemId == rhs.planetarySystemId and
                   lhs.bodyId            == rhs.bodyId            and
                   float_eq(lhs.radius, rhs.radius)               and
                   float_eq(lhs.center.x, rhs.center.x)           and
                   float_eq(lhs.center.y, rhs.center.y)           and
                   float_eq(lhs.center.z, rhs.center.z)           and
                   float_eq(lhs.GM, rhs.GM)
        end
    local function mkBodyParameters(systemId, bodyId, radius, worldCoordinates, GM)
        -- 'worldCoordinates' can be either table or vec3
        assert(isSNumber(systemId),
               'Argument 1 (planetarySystemId) must be a number:' .. type(systemId))
        assert(isSNumber(bodyId),
               'Argument 2 (bodyId) must be a number:' .. type(bodyId))
        assert(isSNumber(radius),
               'Argument 3 (radius) must be a number:' .. type(radius))
        assert(isTable(worldCoordinates),
               'Argument 4 (worldCoordinates) must be a array or vec3.' ..
               type(worldCoordinates))
        assert(isSNumber(GM),
               'Argument 5 (GM) must be a number:' .. type(GM))
        return setmetatable({planetarySystemId = tonumber(systemId),
                             bodyId            = tonumber(bodyId),
                             radius            = tonumber(radius),
                             center            = vec3(worldCoordinates),
                             GM                = tonumber(GM) }, BodyParameters)
    end
    -- MapPosition: Geographical coordinates of a point on a planetary body.
    local MapPosition = {}
    MapPosition.__index = MapPosition
    MapPosition.__tostring = function(p)
            return stringf('::pos{%d,%d,%s,%s,%s}',
                                 p.systemId,
                                 p.bodyId,
                                 formatNumber(p.latitude*rad2deg),
                                 formatNumber(p.longitude*rad2deg),
                                 formatNumber(p.altitude))
        end
    MapPosition.__eq       = function(lhs, rhs)
            return lhs.bodyId   == rhs.bodyId              and
                   lhs.systemId == rhs.systemId            and
                   float_eq(lhs.latitude,   rhs.latitude)  and
                   float_eq(lhs.altitude,   rhs.altitude)  and
                   (float_eq(lhs.longitude, rhs.longitude) or
                    float_eq(lhs.latitude, math.pi/2)      or
                    float_eq(lhs.latitude, -math.pi/2))
        end
    -- latitude and longitude are in degrees while altitude is in meters
    local function mkMapPosition(overload, bodyId, latitude, longitude, altitude)
        local systemId = overload -- Id or '::pos{...}' string
        if isString(overload) and not longitude and not altitude and
                                  not bodyId    and not latitude then
            systemId, bodyId, latitude, longitude, altitude =
                                                string.match(overload, posPattern)
            assert(systemId, 'Argument 1 (position string) is malformed.')
        else
            assert(isSNumber(systemId),
                   'Argument 1 (systemId) must be a number:' .. type(systemId))
            assert(isSNumber(bodyId),
                   'Argument 2 (bodyId) must be a number:' .. type(bodyId))
            assert(isSNumber(latitude),
                   'Argument 3 (latitude) must be in degrees:' .. type(latitude))
            assert(isSNumber(longitude),
                   'Argument 4 (longitude) must be in degrees:' .. type(longitude))
            assert(isSNumber(altitude),
                   'Argument 5 (altitude) must be in meters:' .. type(altitude))
        end
        systemId  = tonumber(systemId)
        bodyId    = tonumber(bodyId)
        latitude  = tonumber(latitude)
        longitude = tonumber(longitude)
        altitude  = tonumber(altitude)
        if bodyId == 0 then -- this is a hack to represent points in space
            return setmetatable({latitude  = latitude,
                                 longitude = longitude,
                                 altitude  = altitude,
                                 bodyId    = bodyId,
                                 systemId  = systemId}, MapPosition)
        end
        return setmetatable({latitude  = deg2rad*clamp(latitude, -90, 90),
                             longitude = deg2rad*(longitude % 360),
                             altitude  = altitude,
                             bodyId    = bodyId,
                             systemId  = systemId}, MapPosition)
    end
    -- PlanetarySystem - map body IDs to BodyParameters
    local PlanetarySystem = {}
    PlanetarySystem.__index = PlanetarySystem
    PlanetarySystem.__tostring =
        function (obj, indent)
            local sep = indent and (indent .. '  ' )
            local bdylist = {}
            local keys = {}
            for k in pairs(obj) do table.insert(keys, k) end
            table.sort(keys)
            for _, bi in ipairs(keys) do
                bdy = obj[bi]
                local bdys = BodyParameters.__tostring(bdy, sep)
                if indent then
                    table.insert(bdylist,
                                 stringf('[%s]={\n%s\n%s}',
                                               bi, bdys, indent))
                else
                    table.insert(bdylist, stringf('  [%s]=%s', bi, bdys))
                end
            end
            if indent then
                return stringf('\n%s%s%s',
                                     indent,
                                     table.concat(bdylist, ',\n' .. indent),
                                     indent)
            end
            return stringf('{\n%s\n}', table.concat(bdylist, ',\n'))
        end
    local function mkPlanetarySystem(referenceTable)
        local atlas = {}
        local pid
        for _, v in pairs(referenceTable) do
            local id = v.planetarySystemId
            if type(id) ~= 'number' then
                error('Invalid planetary system ID: ' .. tostring(id))
            elseif pid and id ~= pid then
                error('Mismatch planetary system IDs: ' .. id .. ' and '
                      .. pid)
            end
            local bid = v.bodyId
            if type(bid) ~= 'number' then
                error('Invalid body ID: ' .. tostring(bid))
            elseif atlas[bid] then
                error('Duplicate body ID: ' .. tostring(bid))
            end
            setmetatable(v.center, getmetatable(vec3.unit_x))
            atlas[bid] = setmetatable(v, BodyParameters)
            pid = id
        end
        return setmetatable(atlas, PlanetarySystem)
    end
    -- PlanetaryReference - map planetary system ID to PlanetarySystem
    PlanetaryReference = {}
    local function mkPlanetaryReference(referenceTable)
        return setmetatable({ galaxyAtlas = referenceTable or {} },
                              PlanetaryReference)
    end
    PlanetaryReference.__index        = 
        function(t,i)
            if type(i) == 'number' then
                local system = t.galaxyAtlas[i]
                return mkPlanetarySystem(system)
            end
            return rawget(PlanetaryReference, i)
        end
    PlanetaryReference.__pairs        =
        function(obj)
            return  function(t, k)
                        local nk, nv = next(t, k)
                        return nk, nv and mkPlanetarySystem(nv)
                    end, obj.galaxyAtlas, nil
        end
    PlanetaryReference.__tostring     =
        function (obj)
            local pslist = {}
            for _,ps in pairs(obj or {}) do
                local psi = ps:getPlanetarySystemId()
                local pss = PlanetarySystem.__tostring(ps, '    ')
                table.insert(pslist,
                             stringf('  [%s]={%s\n  }', psi, pss))
            end
            return stringf('{\n%s\n}\n', table.concat(pslist,',\n'))
        end
    PlanetaryReference.BodyParameters = mkBodyParameters
    PlanetaryReference.MapPosition    = mkMapPosition
    PlanetaryReference.PlanetarySystem = mkPlanetarySystem
    function PlanetaryReference.createBodyParameters(planetarySystemId,
                                                     bodyId,
                                                     surfaceArea,
                                                     aPosition,
                                                     verticalAtPosition,
                                                     altitudeAtPosition,
                                                     gravityAtPosition)
        assert(isSNumber(planetarySystemId),
               'Argument 1 (planetarySystemId) must be a number:' ..
               type(planetarySystemId))
        assert(isSNumber(bodyId),
               'Argument 2 (bodyId) must be a number:' .. type(bodyId))
        assert(isSNumber(surfaceArea),
               'Argument 3 (surfaceArea) must be a number:' .. type(surfaceArea))
        assert(isTable(aPosition),
               'Argument 4 (aPosition) must be an array or vec3:' ..
               type(aPosition))
        assert(isTable(verticalAtPosition),
               'Argument 5 (verticalAtPosition) must be an array or vec3:' ..
               type(verticalAtPosition))
        assert(isSNumber(altitudeAtPosition),
               'Argument 6 (altitude) must be in meters:' ..
               type(altitudeAtPosition))
        assert(isSNumber(gravityAtPosition),
               'Argument 7 (gravityAtPosition) must be number:' ..
               type(gravityAtPosition))
        local radius   = math.sqrt(surfaceArea/4/math.pi)
        local distance = radius + altitudeAtPosition
        local center   = vec3(aPosition) + distance*vec3(verticalAtPosition)
        local GM       = gravityAtPosition * distance * distance
        return mkBodyParameters(planetarySystemId, bodyId, radius, center, GM)
end

PlanetaryReference.isMapPosition  = isMapPosition

function PlanetaryReference:getPlanetarySystem(overload)
    --if galaxyAtlas then
        local planetarySystemId = overload
        if isMapPosition(overload) then
            planetarySystemId = overload.systemId
        end
        if type(planetarySystemId) == 'number' then
            local system = self.galaxyAtlas[i]
            if system then
                if getmetatable(nv) ~= PlanetarySystem then
                    system = mkPlanetarySystem(system)
                end
                return system
            end
        end
    --end
    --return nil
end

function PlanetarySystem:castIntersections(origin,
                                           direction,
                                           sizeCalculator,
                                           bodyIds)
    local sizeCalculator = sizeCalculator or 
                            function (body) return 1.05*body.radius end
    local candidates = {}
    if bodyIds then
        for _,i in ipairs(bodyIds) do candidates[i] = self[i] end
    else
        bodyIds = {}
        for k,body in pairs(self) do
            table.insert(bodyIds, k)
            candidates[k] = body
        end
    end
    local function compare(b1,b2)
        local v1 = candidates[b1].center - origin
        local v2 = candidates[b2].center - origin
        return v1:len() < v2:len()
    end
    table.sort(bodyIds, compare)
    local dir = direction:normalize()
    for i, id in ipairs(bodyIds) do
        local body   = candidates[id]
        local c_oV3  = body.center - origin
        local radius = sizeCalculator(body)
        local dot    = c_oV3:dot(dir)
        local desc   = dot^2 - (c_oV3:len2() - radius^2)
        if desc >= 0 then
            local root     = math.sqrt(desc)
            local farSide  = dot + root
            local nearSide = dot - root
            if nearSide > 0 then
                return body, farSide, nearSide
            elseif farSide > 0 then
                return body, farSide, nil
            end
        end
    end
    return nil, nil, nil
end

function PlanetarySystem:closestBody(coordinates)
    assert(type(coordinates) == 'table', 'Invalid coordinates.')
    local minDistance2, body
    local coord = vec3(coordinates)
    for _,params in pairs(self) do
        local distance2 = (params.center - coord):len2()
        if not body or distance2 < minDistance2 then
            body         = params
            minDistance2 = distance2
        end
    end
    return body
end

function PlanetarySystem:convertToBodyIdAndWorldCoordinates(overload)
    local mapPosition = overload
    if isString(overload) then
        mapPosition = mkMapPosition(overload)
    end
    if mapPosition.bodyId == 0 then
        return 0, vec3(mapPosition.latitude,
                       mapPosition.longitude,
                       mapPosition.altitude)
    end
    local params = self:getBodyParameters(mapPosition)
    if params then
        return mapPosition.bodyId,
               params:convertToWorldCoordinates(mapPosition)
    end
end

function PlanetarySystem:getBodyParameters(overload)
    local bodyId = overload
    if isMapPosition(overload) then
        bodyId = overload.bodyId
    end
    assert(isSNumber(bodyId),
               'Argument 1 (bodyId) must be a number:' .. type(bodyId))
    return self[bodyId]
end

function PlanetarySystem:getPlanetarySystemId()
    local k, v = next(self)
    return v and v.planetarySystemId
end

function BodyParameters:convertToMapPosition(worldCoordinates)
    assert(isTable(worldCoordinates),
           'Argument 1 (worldCoordinates) must be an array or vec3:' ..
           type(worldCoordinates))
    local worldVec  = vec3(worldCoordinates) 
    if self.bodyId == 0 then
        return setmetatable({latitude  = worldVec.x,
                             longitude = worldVec.y,
                             altitude  = worldVec.z,
                             bodyId    = 0,
                             systemId  = self.planetarySystemId}, MapPosition)
    end
    local coords    = worldVec - self.center
    local distance  = coords:len()
    local altitude  = distance - self.radius
    local latitude  = 0
    local longitude = 0
    if not float_eq(distance, 0) then
        local phi = math.atan(coords.y, coords.x)
        longitude = phi >= 0 and phi or (2*math.pi + phi)
        latitude  = math.pi/2 - math.acos(coords.z/distance)
    end
    return setmetatable({latitude  = latitude,
                         longitude = longitude,
                         altitude  = altitude,
                         bodyId    = self.bodyId,
                         systemId  = self.planetarySystemId}, MapPosition)
end

function BodyParameters:convertToWorldCoordinates(overload)
    local mapPosition = isString(overload) and
                                           mkMapPosition(overload) or overload
    if mapPosition.bodyId == 0 then -- support deep space map position
        return vec3(mapPosition.latitude,
                    mapPosition.longitude,
                    mapPosition.altitude)
    end
    assert(isMapPosition(mapPosition),
           'Argument 1 (mapPosition) is not an instance of "MapPosition".')
    assert(mapPosition.systemId == self.planetarySystemId,
           'Argument 1 (mapPosition) has a different planetary system ID.')
    assert(mapPosition.bodyId == self.bodyId,
           'Argument 1 (mapPosition) has a different planetary body ID.')
    local xproj = math.cos(mapPosition.latitude)
    return self.center + (self.radius + mapPosition.altitude) *
           vec3(xproj*math.cos(mapPosition.longitude),
                xproj*math.sin(mapPosition.longitude),
                math.sin(mapPosition.latitude))
end

function BodyParameters:getAltitude(worldCoordinates)
    return (vec3(worldCoordinates) - self.center):len() - self.radius
end

function BodyParameters:getDistance(worldCoordinates)
    return (vec3(worldCoordinates) - self.center):len()
end

function BodyParameters:getGravity(worldCoordinates)
    local radial = self.center - vec3(worldCoordinates) -- directed towards body
    local len2   = radial:len2()
    return (self.GM/len2) * radial/math.sqrt(len2)
end
-- end of module
return setmetatable(PlanetaryReference,
                    { __call = function(_,...)
                                    return mkPlanetaryReference(...)
                               end })
end

PlanetaryReference = PlanetRef()
galaxyReference = PlanetaryReference(Atlas())
Kinematic = Kinematics()
Kep = Keplers()
